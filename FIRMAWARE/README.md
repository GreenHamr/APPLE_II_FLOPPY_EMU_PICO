# Apple II Floppy Disk Emulator за Raspberry Pi Pico

Този проект симулира флопи дисково устройство за Apple II компютър, което чете дискови имиджи от SD карта.

## Характеристики

- **Поддържани формати**: 
  - DOS 3.3 (13 сектора на пътека)
  - ProDOS (16 сектора на пътека)
  - Автоматично определяне на формат
- **Пътеки**: 35 пътеки (0-34)
- **Кодиране**: GCR (Group Code Recording)
- **Източник на данни**: SD карта (FAT32)
- **Файлов формат**: .dsk файлове
- **Режим**: Четене и запис (write-enabled по подразбиране)
- **UI**: OLED дисплей 128x64 (SSD1306) + Ротационен енкодер
- **Времеване**: PIO/DMA за точно времеване на сигналите
- **Множество дискови имиджи**: Поддръжка на до 10 .dsk файла
- **Конфигурируеми GPIO**: Всички GPIO пинове са конфигурируеми
- **Interrupt обработка**: За по-добра производителност
- **Автоматично определяне на сектор**: При запис автоматично определя номера на сектора

## Хардуерни връзки

### GPIO Pin Assignments

#### Фазови сигнали (от Apple II контролер)
- **GPIO 0**: PH0 (Фаза 0)
- **GPIO 1**: PH1 (Фаза 1)
- **GPIO 2**: PH2 (Фаза 2)
- **GPIO 3**: PH3 (Фаза 3)

#### Сигнали от Apple II контролер
- **GPIO 5**: MOTOR_ON (Мотор включен)
- **GPIO 6**: WRITE_ENABLE (Разрешение за запис)
- **GPIO 7**: WRITE_DATA (Данни за запис)

#### Сигнали към Apple II контролер
- **GPIO 8**: READ_DATA (Данни за четене)
- **GPIO 9**: TRACK0 (Индикатор за пътека 0, active low)
- **GPIO 10**: WRITE_PROTECT (Защита от запис, active low)

#### SD Card SPI
- **GPIO 16**: MISO (Master In Slave Out)
- **GPIO 17**: CS (Chip Select)
- **GPIO 18**: SCK (Serial Clock)
- **GPIO 19**: MOSI (Master Out Slave In)

#### Индикация
- **GPIO 25**: LED (вградена LED на Pico)

#### UI компоненти
- **GPIO 11**: Енкодер Pin A
- **GPIO 12**: Енкодер Pin B
- **GPIO 13**: Енкодер Button
- **GPIO 20**: I2C SDA (OLED дисплей)
- **GPIO 21**: I2C SCL (OLED дисплей)

## Формат на дисковия имидж

Дисковият имидж трябва да е в необработен (raw) формат:
- **Размер**: 143,360 байта (35 пътеки × 16 сектора × 256 байта)
- **Формат**: Бинарен файл без заглавки
- **Разположение**: Първите 512 байта на SD картата (блок 0)

### Структура на данните

```
Пътека 0:  Сектор 0-15  (4096 байта)
Пътека 1:  Сектор 0-15  (4096 байта)
...
Пътека 34: Сектор 0-15  (4096 байта)
```

## Компилиране

1. Уверете се, че имате инсталиран Raspberry Pi Pico SDK
2. Създайте директория `build`:
   ```bash
   mkdir build
   cd build
   ```
3. Изпълнете CMake:
   ```bash
   cmake ..
   ```
4. Компилирайте:
   ```bash
   make
   ```
   или
   ```bash
   ninja
   ```

## Инсталиране

1. Свържете Raspberry Pi Pico в режим BOOTSEL (задръжте BOOTSEL бутона при включване)
2. Копирайте `Floppy_PICO_green.uf2` файла в Pico диска
3. Подгответе SD картата с дисковия имидж

## Подготовка на SD картата

1. Форматирайте SD картата като FAT32
2. Копирайте дисковия имидж файл в корена на картата
3. За опростена версия, дисковият имидж трябва да започва от блок 0

**Забележка**: В текущата версия, кодът чете директно от блок 0 на SD картата. За пълна поддръжка на файлова система, трябва да се добави библиотека като FatFS.

## Използване

1. Свържете Pico към Apple II чрез подходящ кабел
2. Свържете OLED дисплей (SSD1306) към I2C (GPIO 20/21)
3. Свържете ротационен енкодер (GPIO 11/12/13)
4. Включете системата
5. Използвайте енкодера за навигация в менюто:
   - Завъртане: Промяна на селекцията
   - Натискане: Изпълнение на избраното действие
6. OLED дисплей показва:
   - Статус на мотор
   - Текуща пътека
   - Статус на диск
   - Write protect статус
   - Меню опции

## Отстраняване на проблеми

### SD картата не се инициализира
- Проверете връзките на SPI пиновете
- Уверете се, че SD картата е форматирана като FAT32
- Проверете захранването на SD картата

### Не се четат данни
- Проверете връзките на GPIO пиновете
- Уверете се, че дисковият имидж е в правилния формат
- Проверете UART изхода за съобщения за грешки

### Моторът не работи
- Проверете връзките на фазовите сигнали
- Уверете се, че Apple II контролерът изпраща правилните сигнали

## Технически детайли

### PIO/DMA имплементация

Проектът използва PIO (Programmable I/O) и DMA за точно времеване на сигналите:

- **READ_DATA**: PIO програма генерира сигнала с точно времеване (125 kHz). DMA прехвърля данните от паметта към PIO FIFO.
- **WRITE_DATA**: PIO програма улавя сигнала с точно времеване. DMA прехвърля данните от PIO FIFO към паметта.

Това осигурява:
- Точно времеване на битовете (8 микросекунди на бит)
- Минимално натоварване на CPU
- Високо ниво на производителност

## Ограничения

1. **FatFS библиотека**: Текущата версия използва опростена FatFS имплементация. За пълна функционалност се препоръчва използване на официалната FatFS библиотека.
2. **Номер на сектор при запис**: В текущата версия номерът на сектора се определя от `current_write_sector`. В реална имплементация трябва да се извлича от данните или позицията на главата.

## Реализирани функционалности

- [x] Пълна поддръжка на FatFS за четене на файлове от SD картата
- [x] Поддръжка на запис на диск
- [x] PIO/DMA базирана READ_DATA генерация за точно времеване
- [x] PIO/DMA базирана WRITE_DATA обработка за прецизно улавяне на битове
- [x] Поддръжка на различни формати (13 сектора, DOS 3.3, ProDOS)
- [x] Конфигурируеми GPIO пинове
- [x] Поддръжка на множество дискови имиджи
- [x] Автоматично определяне на номера на сектора при запис
- [x] Interrupt базирана обработка за по-добра производителност

## Бъдещи подобрения

- [ ] Подобрена секторна детекция (по-прецизно парсване на DOS 3.3/ProDOS заглавки)
- [ ] Поддръжка на повече формати (Apple Pascal, etc.)
- [ ] Конфигурационен файл за GPIO пинове
- [ ] Поддръжка на повече от 10 дискови имиджи
- [ ] Меню за избор на диск от UI

## Лиценз

Този проект е създаден за образователни цели.

## Автор

Създадено за PRAVETZ-8D проект.

